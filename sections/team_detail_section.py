import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from typing import Dict
from utils.poisson_utils import (
    calculate_elo_ratings, calculate_form_emojis, calculate_expected_and_actual_points,
    aggregate_team_stats, calculate_team_pseudo_xg, add_btts_column,
    calculate_conceded_goals, calculate_recent_team_form,
    calculate_elo_changes, calculate_team_styles,
    calculate_clean_sheets, intensity_score_to_emoji, compute_score_stats, compute_form_trend,
    merged_home_away_opponent_form,classify_team_strength,calculate_advanced_team_metrics,
    calculate_team_extra_stats,get_team_record,analyze_team_profile,generate_team_comparison,render_team_comparison_section
)

def render_team_detail(
    df: pd.DataFrame,
    season_df: pd.DataFrame,
    team: str,
    league_name: str,
    gii_dict: Dict[str, float],
) -> None:
    """Render detailed information for a selected team.

    Args:
        df: DataFrame containing match data.
        season_df: DataFrame with season data for statistics.
        team: Team name to display.
        league_name: Name of the league.
        gii_dict: Mapping of teams to intensity index values.

    Returns:
        None
    """
    st.sidebar.markdown("### ‚è±Ô∏è ƒåasov√Ω filtr")
    min_date, max_date = df['Date'].min(), df['Date'].max()

    time_filter = st.sidebar.radio(
        "Vyber rozsah dat",
        ["Cel√° sez√≥na", "Posledn√≠ch 5 z√°pas≈Ø", "Posledn√≠ch 10 z√°pas≈Ø", "Posledn√≠ch 5 doma", "Posledn√≠ch 5 venku"]
    )

    def _apply_time_filter(data: pd.DataFrame) -> pd.DataFrame:
        df_sorted = data.sort_values("Date")
        df_sorted["DateDiff"] = df_sorted["Date"].diff().dt.days
        gap_threshold = 30
        latest_index = df_sorted[df_sorted["Date"] == df_sorted["Date"].max()].index[0]
        cutoff_idx = df_sorted.iloc[:latest_index].loc[df_sorted["DateDiff"] > gap_threshold].last_valid_index()
        season_start = df_sorted.loc[cutoff_idx + 1, "Date"] if cutoff_idx is not None else df_sorted["Date"].min()
        season_cutoff = data[data['Date'] >= season_start]

        if time_filter == "Posledn√≠ch 5 z√°pas≈Ø":
            matches = season_cutoff[(season_cutoff['HomeTeam'] == team) | (season_cutoff['AwayTeam'] == team)]
            return matches.sort_values("Date", ascending=False).head(5)
        if time_filter == "Posledn√≠ch 10 z√°pas≈Ø":
            matches = season_cutoff[(season_cutoff['HomeTeam'] == team) | (season_cutoff['AwayTeam'] == team)]
            return matches.sort_values("Date", ascending=False).head(10)
        if time_filter == "Posledn√≠ch 5 doma":
            matches = season_cutoff[season_cutoff['HomeTeam'] == team]
            return matches.sort_values("Date", ascending=False).head(5)
        if time_filter == "Posledn√≠ch 5 venku":
            matches = season_cutoff[season_cutoff['AwayTeam'] == team]
            return matches.sort_values("Date", ascending=False).head(5)
        return season_cutoff

    df = _apply_time_filter(df)

    difficulty_filter = st.sidebar.selectbox(
        "üéØ Filtrovat podle s√≠ly soupe≈ôe:",
        ["V≈°e", "Siln√≠", "Pr≈Ømƒõrn√≠", "Slab√≠"]
    )

    compare_team = st.sidebar.selectbox(
        "üîÑ Porovnat s jin√Ωm t√Ωmem:",
        ["≈Ω√°dn√Ω"] + sorted(df['HomeTeam'].unique().tolist())
    )

    def _apply_difficulty_filter(data: pd.DataFrame) -> pd.DataFrame:
        if difficulty_filter != "V≈°e":
            data = data.copy()
            data["Opponent"] = data.apply(lambda row: row['AwayTeam'] if row['HomeTeam'] == team else row['HomeTeam'], axis=1)
            data["Soupe≈ô s√≠la"] = data["Opponent"].apply(lambda opp: classify_team_strength(df, opp))
            data = data[data["Soupe≈ô s√≠la"] == difficulty_filter]
        return data

    season_df = _apply_difficulty_filter(df)

    home = season_df[season_df['HomeTeam'] == team]
    away = season_df[season_df['AwayTeam'] == team]
    all_matches = pd.concat([home, away])

    if compare_team and compare_team != "≈Ω√°dn√Ω" and compare_team != team:
        stats_all = calculate_advanced_team_metrics(all_matches)
        stats_home = calculate_advanced_team_metrics(home, is_home=True)
        stats_away = calculate_advanced_team_metrics(away, is_home=False)

        # ‚¨áÔ∏è pou≈æij p≈Øvodn√≠ df (ne season_df) pro druh√Ω t√Ωm
        compare_home = df[df['HomeTeam'] == compare_team]
        compare_away = df[df['AwayTeam'] == compare_team]

        compare_matches = pd.concat([compare_home, compare_away])

        if team in stats_all.index and compare_team in calculate_advanced_team_metrics(compare_matches).index:
            render_team_comparison_section(
                team, compare_team,
                stats_all.loc[team], stats_home.loc[team], stats_away.loc[team],
                calculate_advanced_team_metrics(compare_matches).loc[compare_team],
                calculate_advanced_team_metrics(compare_home, is_home=True).loc[compare_team],
                calculate_advanced_team_metrics(compare_away, is_home=False).loc[compare_team]
            )
            return
        else:
            st.warning("‚ö†Ô∏è Jeden z t√Ωm≈Ø nem√° dostupn√° data pro zvolen√Ω filtr.")
            return






    st.header(f"üìå Detail t√Ωmu: {team}")

    # V√Ωpoƒçet pro v≈°echny t≈ôi varianty
    # V√Ωpoƒçty
    record_all = get_team_record(season_df, team)
    record_home = get_team_record(season_df, team, side="home")
    record_away = get_team_record(season_df, team, side="away")

    # V√Ωpis bilance
    st.markdown(
        f"**üìä Bilance:** &nbsp;&nbsp;&nbsp;"
        f"üü¶ Celkem ‚Äì ‚úÖ {record_all[0]} | ü§ù {record_all[1]} | ‚ùå {record_all[2]} &nbsp;&nbsp;&nbsp;"
        f"üè† Doma ‚Äì ‚úÖ {record_home[0]} | ü§ù {record_home[1]} | ‚ùå {record_home[2]} &nbsp;&nbsp;&nbsp;"
        f"üöå Venku ‚Äì ‚úÖ {record_away[0]} | ü§ù {record_away[1]} | ‚ùå {record_away[2]}",
        unsafe_allow_html=True
    )



    
    team_stats = aggregate_team_stats(season_df)
    if team not in team_stats.index:
        st.error(f"T√Ωm '{team}' nebyl nalezen v datech. Zkontroluj spr√°vnost n√°zvu.")
        st.stop()

    
    # Ligov√Ω pr≈Ømƒõr
    league_avg = team_stats.mean()
    def compare_stat(name, team_value, league_avg):
        league_value = league_avg.get(name, 0)
        diff = team_value - league_value
        return f" *(liga: {league_value:.2f}, Œî {diff:+.2f})*"

    advanced_stats = calculate_advanced_team_metrics(season_df)
    league_avg_advanced = advanced_stats.mean()

    
    
    
    stats = team_stats.loc[team]
    #card_stats = get_team_card_stats(season_df, team)
    # stats['≈Ωlut√©'] = card_stats['yellow']
    # stats['ƒåerven√©'] = card_stats['red']
    elo_dict = calculate_elo_ratings(season_df)

    # ‚úÖ Kontrola rozsahu dat a poƒçtu z√°pas≈Ø
    st.caption(f"Poƒçet z√°pas≈Ø v aktu√°ln√≠m datasetu: {len(season_df)}")
    st.caption(f"Rozsah dat: {season_df['Date'].min().date()} a≈æ {season_df['Date'].max().date()}")

    # ‚úÖ xG a xGA ‚Äì kontrola struktury + fallback
    # V√Ωpoƒçet xG / xGA se zarovn√°n√≠m n√°zvu t√Ωmu
    from utils.poisson_utils.xg import calculate_team_pseudo_xg
    xg_dict = calculate_team_pseudo_xg(season_df)
    # kl√≠ƒçe bez mezer a lowercase (normalize)
    normalized_xg_dict = {k.strip().lower(): v for k, v in xg_dict.items()}
    normalized_team = team.strip().lower()

    team_xg_data = normalized_xg_dict.get(normalized_team, {})
    team_xg = team_xg_data.get("xg", 0)
    team_xga = team_xg_data.get("xga", 0)

    # V√Ωpoƒçet BTTS, Over 2.5 a pr≈Ømƒõr celkov√Ωch g√≥l≈Ø
    team_matches = season_df[(season_df['HomeTeam'] == team) | (season_df['AwayTeam'] == team)].copy()
    team_matches = team_matches.dropna(subset=["FTHG", "FTAG"])

    btts_pct = 100 * ((team_matches["FTHG"] > 0) & (team_matches["FTAG"] > 0)).mean()
    over25_pct = 100 * ((team_matches["FTHG"] + team_matches["FTAG"]) > 2.5).mean()
    avg_total_goals = (team_matches["FTHG"] + team_matches["FTAG"]).mean()

    #card_stats = get_team_card_stats(season_df, team)
    # yellow_per_foul = card_stats["yellow"] / card_stats["fouls"] if card_stats["fouls"] else 0
    # red_per_foul = card_stats["red"] / card_stats["fouls"] if card_stats["fouls"] else 0

    # ‚úÖ Oƒçek√°van√© body
    xp_data = calculate_expected_and_actual_points(season_df).get(team, {})
    expected_points = xp_data.get("expected_points", 0)
    clean_pct = calculate_clean_sheets(season_df, team)

    

    def calc_metrics(df, is_home=None):
        if is_home is None:  # All matches
            goals = pd.concat([df[df['HomeTeam'] == team]['FTHG'], df[df['AwayTeam'] == team]['FTAG']]).mean()
            conceded = pd.concat([df[df['HomeTeam'] == team]['FTAG'], df[df['AwayTeam'] == team]['FTHG']]).mean()
            shots = pd.concat([df[df['HomeTeam'] == team]['HS'], df[df['AwayTeam'] == team]['AS']]).mean()
            shots_on = pd.concat([df[df['HomeTeam'] == team]['HST'], df[df['AwayTeam'] == team]['AST']]).mean()
            corners = pd.concat([df[df['HomeTeam'] == team]['HC'], df[df['AwayTeam'] == team]['AC']]).mean()
            fouls = pd.concat([df[df['HomeTeam'] == team]['HF'], df[df['AwayTeam'] == team]['AF']]).mean()
            yellow = pd.concat([df[df['HomeTeam'] == team]['HY'], df[df['AwayTeam'] == team]['AY']]).mean()
            red = pd.concat([df[df['HomeTeam'] == team]['HR'], df[df['AwayTeam'] == team]['AR']]).mean()
        else:
            goals = df['FTHG'].mean() if is_home else df['FTAG'].mean()
            conceded = df['FTAG'].mean() if is_home else df['FTHG'].mean()
            shots = df['HS'].mean() if is_home else df['AS'].mean()
            shots_on = df['HST'].mean() if is_home else df['AST'].mean()
            corners = df['HC'].mean() if is_home else df['AC'].mean()
            fouls = df['HF'].mean() if is_home else df['AF'].mean()
            yellow = df['HY'].mean() if is_home else df['AY'].mean()
            red = df['HR'].mean() if is_home else df['AR'].mean()

        return {
            "G√≥ly": goals,
            "Obdr≈æen√© g√≥ly": conceded,
            "St≈ôely": shots,
            "Na branku": shots_on,
            "Rohy": corners,
            "Fauly": fouls,
            "≈Ωlut√©": yellow,
            "ƒåerven√©": red,
        }

    # V√Ωpoƒçet metrik a ligov√©ho pr≈Ømƒõru
    metrics_all = calc_metrics(all_matches)
    metrics_home = calc_metrics(home, is_home=True)
    metrics_away = calc_metrics(away, is_home=False)

    extra_all = calculate_team_extra_stats(all_matches, team)
    extra_home = calculate_team_extra_stats(home, team)
    extra_away = calculate_team_extra_stats(away, team)

    
    st.markdown("### üìä Pr≈Ømƒõrn√© statistiky ‚Äì Celkem / Doma / Venku")
    col_all, col_home, col_away = st.columns(3)

    # Funkce pro delta barvy
    def colored_delta(value, league_avg, metric_name):
        diff = value - league_avg
        arrow = "‚¨ÜÔ∏è" if diff > 0 else "‚¨áÔ∏è"
        
        # Metriky, kde vy≈°≈°√≠ hodnota je ≈°patnƒõ
        inverse_metrics = ["Obdr≈æen√© g√≥ly", "Fauly", "≈Ωlut√©", "ƒåerven√©"]
        inverse = metric_name in inverse_metrics
        
        color = "red" if (diff > 0 and inverse) or (diff < 0 and not inverse) else "green"
        return f"<span style='color:{color}'>{arrow} {diff:+.2f}</span>"

    # Funkce pro v√Ωpis jednoho sloupce
    # def display_metrics_block(col, title, data, adv_data, extra):
    #     with col:
    #         st.markdown(f"#### {title}")
            
    #         # Z√°kladn√≠ metriky
    #         st.markdown(f"**‚öΩ G√≥ly:** {data['G√≥ly']:.2f} {colored_delta(data['G√≥ly'], league_avg['G√≥ly'], 'G√≥ly')}", unsafe_allow_html=True)
    #         st.markdown(f"**ü•Ö Obdr≈æen√© g√≥ly:** {data['Obdr≈æen√© g√≥ly']:.2f} {colored_delta(data['Obdr≈æen√© g√≥ly'], league_avg['Obdr≈æen√© g√≥ly'], 'Obdr≈æen√© g√≥ly')}", unsafe_allow_html=True)
    #         st.markdown(f"**üì∏ St≈ôely:** {data['St≈ôely']:.2f} {colored_delta(data['St≈ôely'], league_avg['St≈ôely'], 'St≈ôely')}", unsafe_allow_html=True)
    #         st.markdown(f"**üéØ Na branku:** {data['Na branku']:.2f} {colored_delta(data['Na branku'], league_avg['Na branku'], 'Na branku')}", unsafe_allow_html=True)
    #         st.markdown(f"**üö© Rohy:** {data['Rohy']:.2f} {colored_delta(data['Rohy'], league_avg['Rohy'], 'Rohy')}", unsafe_allow_html=True)
    #         st.markdown(f"**‚ö†Ô∏è Fauly:** {data['Fauly']:.2f} {colored_delta(data['Fauly'], league_avg['Fauly'], 'Fauly')}", unsafe_allow_html=True)
    #         st.markdown(f"**üü® ≈Ωlut√©:** {data['≈Ωlut√©']:.2f} {colored_delta(data['≈Ωlut√©'], league_avg['≈Ωlut√©'], '≈Ωlut√©')}", unsafe_allow_html=True)
    #         st.markdown(f"**üü• ƒåerven√©:** {data['ƒåerven√©']:.2f} {colored_delta(data['ƒåerven√©'], league_avg['ƒåerven√©'], 'ƒåerven√©')}", unsafe_allow_html=True)
    #         # st.markdown(f"**‚ö° Ofenzivn√≠ efektivita:** {adv_data['Ofenzivn√≠ efektivita']:.2f} {colored_delta(adv_data['Ofenzivn√≠ efektivita'], league_avg_advanced['Ofenzivn√≠ efektivita'], 'Ofenzivn√≠ efektivita')}", unsafe_allow_html=True)
    #         # st.markdown(f"**üõ°Ô∏è Defenzivn√≠ efektivita:** {adv_data['Defenzivn√≠ efektivita']:.2f} {colored_delta(adv_data['Defenzivn√≠ efektivita'], league_avg_advanced['Defenzivn√≠ efektivita'], 'Defenzivn√≠ efektivita')}", unsafe_allow_html=True)
    #         st.markdown(f"**üéØ P≈ôesnost st≈ôel:** {adv_data['P≈ôesnost st≈ôel'] * 100:.1f}% {colored_delta(adv_data['P≈ôesnost st≈ôel'], league_avg_advanced['P≈ôesnost st≈ôel'], 'P≈ôesnost st≈ôel')}", unsafe_allow_html=True)
    #         st.markdown(f"**üåü Konverzn√≠ m√≠ra:** {adv_data['Konverzn√≠ m√≠ra'] * 100:.1f}% {colored_delta(adv_data['Konverzn√≠ m√≠ra'], league_avg_advanced['Konverzn√≠ m√≠ra'], 'Konverzn√≠ m√≠ra')}", unsafe_allow_html=True)
    #         st.markdown(f"**üß§ ƒåist√° konta:** {extra['ƒåist√° konta %']:.1f}%", unsafe_allow_html=True)
    #         st.markdown(f"**üìà Over 2.5 %:** {extra['Over 2.5 %']:.1f}%", unsafe_allow_html=True)
    #         st.markdown(f"**üéØ BTTS %:** {extra['BTTS %']:.1f}%", unsafe_allow_html=True)

    def display_metrics_block(col, title, data, advanced, extra, show_labels=True):
        with col:
            st.markdown(f"### {title}")

            def format_metric(label, value, delta_str):
                if show_labels:
                    return f"**{label}:** {value:.2f} {delta_str}"
                else:
                    return f"{value:.2f} {delta_str}"

            st.markdown(format_metric("‚öΩ G√≥ly", data['G√≥ly'], colored_delta(data['G√≥ly'], league_avg['G√≥ly'], 'G√≥ly')), unsafe_allow_html=True)
            st.markdown(format_metric("ü•Ö Obdr≈æen√© g√≥ly", data['Obdr≈æen√© g√≥ly'], colored_delta(data['Obdr≈æen√© g√≥ly'], league_avg['Obdr≈æen√© g√≥ly'], 'Obdr≈æen√© g√≥ly')), unsafe_allow_html=True)
            st.markdown(format_metric("üì∏ St≈ôely", data['St≈ôely'], colored_delta(data['St≈ôely'], league_avg['St≈ôely'], 'St≈ôely')), unsafe_allow_html=True)
            st.markdown(format_metric("üéØ Na branku", data['Na branku'], colored_delta(data['Na branku'], league_avg['Na branku'], 'Na branku')), unsafe_allow_html=True)
            st.markdown(format_metric("üö© Rohy", data['Rohy'], colored_delta(data['Rohy'], league_avg['Rohy'], 'Rohy')), unsafe_allow_html=True)
            st.markdown(format_metric("‚ö†Ô∏è Fauly", data['Fauly'], colored_delta(data['Fauly'], league_avg['Fauly'], 'Fauly')), unsafe_allow_html=True)
            st.markdown(format_metric("üü® ≈Ωlut√©", data['≈Ωlut√©'], colored_delta(data['≈Ωlut√©'], league_avg['≈Ωlut√©'], '≈Ωlut√©')), unsafe_allow_html=True)
            st.markdown(format_metric("üü• ƒåerven√©", data['ƒåerven√©'], colored_delta(data['ƒåerven√©'], league_avg['ƒåerven√©'], 'ƒåerven√©')), unsafe_allow_html=True)

            st.markdown("---")
            st.markdown(format_metric("üéØ P≈ôesnost st≈ôel", advanced["P≈ôesnost st≈ôel"], colored_delta(advanced["P≈ôesnost st≈ôel"], league_avg_advanced["P≈ôesnost st≈ôel"], "P≈ôesnost st≈ôel")), unsafe_allow_html=True)
            st.markdown(format_metric("üåü Konverzn√≠ m√≠ra", advanced["Konverzn√≠ m√≠ra"], colored_delta(advanced["Konverzn√≠ m√≠ra"], league_avg_advanced["Konverzn√≠ m√≠ra"], "Konverzn√≠ m√≠ra")), unsafe_allow_html=True)
            st.markdown(format_metric("üß§ ƒåist√° konta", extra["ƒåist√° konta %"], ""), unsafe_allow_html=True)
            st.markdown(format_metric("üìà Over 2.5 %", extra["Over 2.5 %"], ""), unsafe_allow_html=True)
            st.markdown(format_metric("üéØ BTTS %", extra["BTTS %"], ""), unsafe_allow_html=True)


    
    # Celkem
    # display_metrics_block(col_all, "Celkem", metrics_all, advanced_stats.loc[team], extra_all)

    # # Doma
    # home_adv = calculate_advanced_team_metrics(home)
    # if not home_adv.empty and team in home_adv.index:
    #     display_metrics_block(col_home, "üè† Doma", metrics_home, home_adv.loc[team], extra_home)

    # # Venku
    # away_adv = calculate_advanced_team_metrics(away)
    # if not away_adv.empty and team in away_adv.index:
    #     display_metrics_block(col_away, "üöå Venku", metrics_away, away_adv.loc[team], extra_away)

    # Celkem
    display_metrics_block(col_all, "Celkem", metrics_all, advanced_stats.loc[team], extra_all, show_labels=True)

    # Doma
    home_adv = calculate_advanced_team_metrics(home)
    if not home_adv.empty and team in home_adv.index:
        display_metrics_block(col_home, "üè† Doma", metrics_home, home_adv.loc[team], extra_home, show_labels=False)

    # Venku
    away_adv = calculate_advanced_team_metrics(away)
    if not away_adv.empty and team in away_adv.index:
        display_metrics_block(col_away, "üöå Venku", metrics_away, away_adv.loc[team], extra_away, show_labels=False)


    st.markdown("---")

    
    
    # ‚úÖ P≈ôiprav z√°pasy t√Ωmu
    df_team = season_df[(season_df['HomeTeam'] == team) | (season_df['AwayTeam'] == team)].copy()

    # P≈ôidat info o soupe≈ôi
    df_team['Opponent'] = df_team.apply(lambda row: row['AwayTeam'] if row['HomeTeam'] == team else row['HomeTeam'], axis=1)
    df_team['H/A'] = df_team.apply(lambda row: 'H' if row['HomeTeam'] == team else 'A', axis=1)

    # ‚úÖ Kategorizace s√≠ly soupe≈ôe
    df_team['Soupe≈ô s√≠la'] = df_team['Opponent'].apply(lambda opp: classify_team_strength(season_df, opp))

    # ‚úÖ Aplikace filtru podle obt√≠≈ænosti
    if difficulty_filter != "V≈°e":
        df_team = df_team[df_team["Soupe≈ô s√≠la"] == difficulty_filter]

    # Posledn√≠ch 5 z√°pas≈Ø
    last_matches = df_team.sort_values("Date", ascending=False).head(5)

    # ‚úÖ Form√°tov√°n√≠ do tabulky
    def format_result(row):
        is_home = row['HomeTeam'] == team
        opponent = row['AwayTeam'] if is_home else row['HomeTeam']
        team_goals = row['FTHG'] if is_home else row['FTAG']
        opp_goals = row['FTAG'] if is_home else row['FTHG']
        return pd.Series({
            "Datum": row['Date'].date(),
            "Soupe≈ô": opponent,  # ‚ùå ≈æ√°dn√Ω prefix
            "H/A": "H" if is_home else "A",
            "Sk√≥re": f"{team_goals}:{opp_goals}",
            "St≈ôely": row['HS'] if is_home else row['AS'],
            "Na branku": row['HST'] if is_home else row['AST'],
            "Rohy": row['HC'] if is_home else row['AC'],
            "Fauly": row['HF'] if is_home else row['AF'],
            "≈Ωlut√©": row['HY'] if is_home else row['AY'],
            "ƒåerven√©": row['HR'] if is_home else row['AR'],
        })

    # ‚úÖ P≈ôevod a styling
    match_details = last_matches.apply(format_result, axis=1)
    match_details = match_details.reset_index(drop=True)  # ‚úÖ odstran√≠ indexov√Ω sloupec

    def highlight_result(row):
        score = row["Sk√≥re"].split(":")
        if len(score) != 2:
            return [""] * len(row)
        team_goals, opp_goals = int(score[0]), int(score[1])
        color = "#d4edda" if team_goals > opp_goals else "#f8d7da" if team_goals < opp_goals else "#fff3cd"
        return [f"background-color: {color}"] * len(row)

    styled_matches = match_details.style.apply(highlight_result, axis=1)

    # ‚úÖ V√Ωstup
    st.markdown("### üïµÔ∏è Posledn√≠ch 5 z√°pas≈Ø")
    # st.dataframe(
    #     styled_matches.hide(axis="index").set_table_attributes('style="width: 100%;"').set_table_styles([
    #         {"selector": "th", "props": [("text-align", "left")]}
    #     ]),
    #     use_container_width=True
    # )
    st.table(styled_matches)

    # Disciplinovanost ‚Äì karty na faul
    yellow_per_foul = stats['≈Ωlut√©'] / stats['Fauly'] if stats['Fauly'] else 0
    red_per_foul = stats.get('ƒåerven√©', 0) / stats['Fauly'] if stats['Fauly'] else 0

    # # Defenzivn√≠ efektivita ‚Äì g√≥l na st≈ôelu
    defensive_efficiency = (stats['Obdr≈æen√© g√≥ly'] / stats['St≈ôely']) if stats['St≈ôely'] else 0

    # # P≈ôesnost a konverze
    conversion_rate = (stats['G√≥ly'] / stats['St≈ôely']) if stats['St≈ôely'] else 0

    df_team = season_df[(season_df['HomeTeam'] == team) | (season_df['AwayTeam'] == team)].copy()
    df_team['Opponent'] = df_team.apply(lambda row: row['AwayTeam'] if row['HomeTeam'] == team else row['HomeTeam'], axis=1)
    df_team['Strength'] = df_team['Opponent'].apply(lambda t: classify_team_strength(season_df, t))

    profile = analyze_team_profile(
        season_df,
        team,
        conversion_rate,
        defensive_efficiency,
        yellow_per_foul,
        red_per_foul
    )
    
    st.markdown("---")
    
    if (
        profile["v√Ωhern√≠ s√©rie"] >= 2 or
        profile["prohern√≠ s√©rie"] >= 2 or
        profile["siln√© str√°nky"] != "Nen√≠ v√Ωrazn√°" or
        profile["rizika"] != "Bez z√°sadn√≠ch slabin" or
        profile["profilov√© hodnocen√≠"]
    ):
        st.markdown("### üìä Zhodnocen√≠ t√Ωmu")
        st.markdown(f"- üî• Aktu√°ln√≠ forma: **{profile['forma']}**")
        if profile["v√Ωhern√≠ s√©rie"] >= 2:
            st.markdown(f"- üèÜ V√Ωhern√≠ s√©rie: **{profile['v√Ωhern√≠ s√©rie']}** z√°pasy")
        if profile["prohern√≠ s√©rie"] >= 2:
            st.markdown(f"- ‚ùå S√©rie proher: **{profile['prohern√≠ s√©rie']}**")
        if profile["bez ƒçist√©ho konta"] >= 3:
            st.markdown(f"- üö´ Bez ƒçist√©ho konta: **{profile['bez ƒçist√©ho konta']}** z√°pas≈Ø")
        if profile["siln√© str√°nky"] != "Nen√≠ v√Ωrazn√°":
            st.markdown(f"- üí™ Siln√© str√°nky: {profile['siln√© str√°nky']}")
        if profile["rizika"] != "Bez z√°sadn√≠ch slabin":
            st.markdown(f"- ‚ö†Ô∏è Rizika: {profile['rizika']}")
        st.markdown(f"- üéØ Styl t√Ωmu: {profile['styl']}")
        if profile["profilov√© hodnocen√≠"]:
            st.markdown("### üß© Dal≈°√≠ pozorov√°n√≠")
            for tag in profile["profilov√© hodnocen√≠"]:
                st.markdown(f"- {tag}")

    
    # def extract_match_stats(row):
    #     is_home = row['HomeTeam'] == team
    #     return pd.Series({
    #         "Soupe≈ô": row['Opponent'],
    #         "Typ soupe≈ôe": row['Strength'],
    #         "G√≥ly": row['FTHG'] if is_home else row['FTAG'],
    #         "St≈ôely": row['HS'] if is_home else row['AS'],
    #         "Na branku": row['HST'] if is_home else row['AST'],
    #         "Rohy": row['HC'] if is_home else row['AC'],
    #         "Fauly": row['HF'] if is_home else row['AF'],
    #         "≈Ωlut√©": row['HY'] if is_home else row['AY'],
    #         "ƒåerven√©": row['HR'] if is_home else row['AR']
    #     })

    # detailed_stats = df_team.apply(extract_match_stats, axis=1)
    # numeric_columns = detailed_stats.select_dtypes(include='number').columns
    # avg_by_strength = detailed_stats.groupby("Typ soupe≈ôe")[numeric_columns].mean().round(2)
    # st.markdown("---")
    # st.subheader("üìâ V√Ωkonnost proti kategori√≠m soupe≈ô≈Ø")
    # st.markdown("Souhrnn√© statistiky proti r≈Øznƒõ siln√Ωm soupe≈ô≈Øm")
    # # Shrnut√≠ discipl√≠ny
    # if yellow_per_foul > 0.25:
    #     st.markdown(f"üü° T√Ωm fauluje pomƒõrnƒõ neuk√°znƒõnƒõ ‚Äì **{yellow_per_foul:.2f}** ≈ælut√Ωch na 1 faul.")
    # else:
    #     st.markdown(f"üü¢ T√Ωm je relativnƒõ disciplinovan√Ω ‚Äì **{yellow_per_foul:.2f}** ≈ælut√Ωch na 1 faul.")

    # if red_per_foul > 0.05:
    #     st.markdown(f"üî¥ Relativnƒõ vysok√Ω v√Ωskyt ƒçerven√Ωch karet: **{red_per_foul:.2f}** na faul.")

    # # Shrnut√≠ konverze a obrany
    # if conversion_rate > 0.15 and defensive_efficiency > 0.12:
    #     st.markdown("üîÅ **Souhrn:** T√Ωm m√° ofenzivn√≠ s√≠lu, ale defenzivn√≠ slabiny.")
    # elif conversion_rate < 0.08 and defensive_efficiency < 0.07:
    #     st.markdown("üß§ **Souhrn:** T√Ωm je defenzivnƒõ pevn√Ω, ale v √∫toku neefektivn√≠.")
    # elif conversion_rate > 0.15 and defensive_efficiency < 0.07:
    #     st.markdown("üí™ **Souhrn:** T√Ωm je dominantn√≠ na obou stran√°ch ‚Äì siln√Ω √∫tok i obrana.")
    # elif conversion_rate < 0.08 and defensive_efficiency > 0.12:
    #     st.markdown("‚ö†Ô∏è **Souhrn:** T√Ωm m√° pot√≠≈æe v √∫toku i v obranƒõ.")

    # if conversion_rate > 0.15:
    #     st.markdown(f"‚öΩ T√Ωm m√° vysokou konverzn√≠ m√≠ru ‚Äì **{conversion_rate*100:.1f}%** st≈ôel konƒç√≠ g√≥lem.")
    # elif conversion_rate < 0.08:
    #     st.markdown(f"üö´ N√≠zk√° konverzn√≠ m√≠ra ‚Äì pouze **{conversion_rate*100:.1f}%** st≈ôel je g√≥lov√Ωch.")

    # if defensive_efficiency > 0.12:
    #     st.markdown(f"‚ùó T√Ωm dost√°v√° g√≥l z ka≈æd√© 8. st≈ôely ‚Äì defenziva je zraniteln√°.")
    # st.table(avg_by_strength.style.format("{:.2f}"))

    # # Verb√°ln√≠ shrnut√≠ v√Ωkonu proti kategori√≠m soupe≈ô≈Ø
    # if set(["Siln√Ω", "Slab√Ω"]).issubset(avg_by_strength.index):
    #     g_strong = avg_by_strength.loc["Siln√Ω", "G√≥ly"]
    #     g_weak = avg_by_strength.loc["Slab√Ω", "G√≥ly"]
    #     d_strong = avg_by_strength.loc["Siln√Ω", "Na branku"]
    #     d_weak = avg_by_strength.loc["Slab√Ω", "Na branku"]
    #     delta_g = g_weak - g_strong
    #     delta_s = d_weak - d_strong
    #     desc = "üìå Proti siln√Ωm t√Ωm≈Øm t√Ωm sk√≥ruje m√©nƒõ" if delta_g > 0.3 else "üìå V√Ωkon proti siln√Ωm je vyrovnan√Ω"
    #     desc += f", rozd√≠l v pr≈Ømƒõru g√≥l≈Ø: **{delta_g:.2f}**, st≈ôel na branku: **{delta_s:.2f}**."
    #     st.markdown(desc)
