import pandas as pd
import numpy as np

from ..utils_warnings import classify_team_strength  # pokud nen√≠ glob√°lnƒõ importov√°no
from .data import prepare_df


def calculate_match_tempo(df: pd.DataFrame, team: str, opponent_elo: float, is_home: bool, elo_dict: dict, last_n: int = 10) -> dict:
    """Spoƒç√≠t√° tempo, dominanci a tvrdost z√°pasu na z√°kladƒõ posledn√≠ch z√°pas≈Ø proti podobnƒõ siln√Ωm soupe≈ô≈Øm (ELO + typ soupe≈ôe)."""
    from datetime import timedelta
    import numpy as np

    df = prepare_df(df)
    latest_date = df['Date'].max()
    one_year_ago = latest_date - timedelta(days=365)
    df = df[df['Date'] >= one_year_ago]  # ‚úÖ filtrujeme posledn√≠ rok

    team_col = 'HomeTeam' if is_home else 'AwayTeam'
    opp_col = 'AwayTeam' if is_home else 'HomeTeam'

    # V≈°echny z√°pasy dan√©ho t√Ωmu
    matches_all = df[df[team_col] == team].copy()
    matches_all['OppELO'] = matches_all[opp_col].map(elo_dict)
    matches_all['EloDiff'] = abs(matches_all['OppELO'] - opponent_elo)

    # ‚úÖ postupn√© roz≈°i≈ôov√°n√≠ ELO rozd√≠lu
    max_elo_diff = 50
    step = 25
    matches = matches_all[matches_all['EloDiff'] <= max_elo_diff]
    while len(matches) < last_n and max_elo_diff <= 200:
        max_elo_diff += step
        matches = matches_all[matches_all['EloDiff'] <= max_elo_diff]

    if matches.empty:
        print(f"[{team}] ‚ö†Ô∏è Nenalezeny ≈æ√°dn√© relevantn√≠ z√°pasy ‚Äî vrac√≠m defaultn√≠ nuly.")
        return {
            "tempo": 0,
            "percentile": 0,
            "rating": "N/A",
            "imbalance": 0.0,
            "imbalance_type": "N/A",
            "aggressiveness_index": 0.0,
            "aggressiveness_rating": "N/A",
            "similar_opponents_tempo": 0.0
        }

    print(f"[{team}] ‚úÖ Pou≈æito {len(matches)} z√°pas≈Ø (ELO diff ‚â§ {max_elo_diff})")

    # Tempo
    shots = matches['HS'] if is_home else matches['AS']
    corners = matches['HC'] if is_home else matches['AC']
    fouls = matches['HF'] if is_home else matches['AF']
    tempo_index = (shots + corners + fouls).median()  # ‚úÖ robustn√≠

    # Agresivita (relativn√≠ podle cel√© ligy)
    yellow_cards = matches['HY'] if is_home else matches['AY']
    red_cards = matches['HR'] if is_home else matches['AR']
    aggressiveness_index = ((yellow_cards + 2 * red_cards + fouls).sum()) / len(matches)

    # üß† Percentilov√© ≈°k√°lov√°n√≠ agresivity
    league_aggs = []
    all_teams = pd.concat([df['HomeTeam'], df['AwayTeam']]).unique()
    for t in all_teams:
        home = df[df['HomeTeam'] == t]
        away = df[df['AwayTeam'] == t]
        if not home.empty or not away.empty:
            f = pd.concat([home['HF'], away['AF']])
            y = pd.concat([home['HY'], away['AY']])
            r = pd.concat([home['HR'], away['AR']])
            agg = ((y + 2 * r + f).sum()) / (len(home) + len(away))
            league_aggs.append(agg)

    p20 = np.percentile(league_aggs, 20)
    p40 = np.percentile(league_aggs, 40)
    p60 = np.percentile(league_aggs, 60)
    p80 = np.percentile(league_aggs, 80)

    if aggressiveness_index < p20:
        aggressiveness_rating = "üïäÔ∏è velmi klidn√©"
    elif aggressiveness_index < p40:
        aggressiveness_rating = "üü¢ korektn√≠"
    elif aggressiveness_index < p60:
        aggressiveness_rating = "üü° tvrd≈°√≠ styl"
    elif aggressiveness_index < p80:
        aggressiveness_rating = "üî¥ tvrd√Ω styl"
    else:
        aggressiveness_rating = "üü• velmi tvrd√Ω"

    # Tempo soupe≈ô≈Ø
    opponent_shots = matches['AS'] if is_home else matches['HS']
    opponent_corners = matches['AC'] if is_home else matches['HC']
    opponent_fouls = matches['AF'] if is_home else matches['HF']
    similar_opponents_tempo = (opponent_shots + opponent_corners + opponent_fouls).median()

    # Percentil tempa v lize
    all_tempos = []
    for t in all_teams:
        home = df[df['HomeTeam'] == t]
        away = df[df['AwayTeam'] == t]
        if not home.empty or not away.empty:
            s = pd.concat([home['HS'], away['AS']])
            c = pd.concat([home['HC'], away['AC']])
            f = pd.concat([home['HF'], away['AF']])
            all_tempos.append((s + c + f).median())

    percentile = round(sum(t < tempo_index for t in all_tempos) / len(all_tempos) * 100, 1)

    if percentile >= 80:
        rating = "‚ö° velmi rychl√©"
    elif percentile >= 40:
        rating = "üéØ st≈ôedn√≠ tempo"
    elif percentile >= 10:
        rating = "üí§ pomal√©"
    else:
        rating = "ü™® velmi pomal√©"

    # ‚öñÔ∏è IMBALANCE ‚Äì jen proti soupe≈ô≈Øm stejn√© s√≠ly
    

    opponent_class = classify_team_strength(df, team=matches[opp_col].iloc[0])
    filtered = matches.copy()
    filtered["Opponent"] = matches[opp_col]
    filtered["OpponentClass"] = filtered["Opponent"].apply(lambda t: classify_team_strength(df, t))
    filtered = filtered[filtered["OpponentClass"] == opponent_class]
    if filtered.empty:
        filtered = matches  # fallback

    goals_for = filtered['FTHG'] if is_home else filtered['FTAG']
    goals_against = filtered['FTAG'] if is_home else filtered['FTHG']
    shots_for = filtered['HS'] if is_home else filtered['AS']
    shots_against = filtered['AS'] if is_home else filtered['HS']

    goal_diff = (goals_for - goals_against).median()
    shot_diff = (shots_for - shots_against).median()

    min_threshold = 0.3
    if goal_diff > min_threshold and shot_diff > min_threshold:
        imbalance_type = "üìà Dominantn√≠"
    elif goal_diff < -min_threshold and shot_diff < -min_threshold:
        imbalance_type = "üìâ Trp√≠c√≠"
    else:
        imbalance_type = "‚öñÔ∏è Neurƒçit√°"

    imbalance = abs(goal_diff) + abs(shot_diff)

    return {
        "tempo": round(tempo_index, 1),
        "percentile": percentile,
        "rating": rating,
        "imbalance": round(imbalance, 2),
        "imbalance_type": imbalance_type,
        "aggressiveness_index": round(aggressiveness_index, 2),
        "aggressiveness_rating": aggressiveness_rating,
        "similar_opponents_tempo": round(similar_opponents_tempo, 1)
    }



def style_team_table(df):
    def style_status(val):
        emoji = "üü¢" if val == "Forma" else "üü°" if val == "Pr≈Ømƒõr" else "üî¥"
        return f"{emoji} {val}"

    def color_performance(val):
        if "Nadpr≈Ømƒõr" in val:
            return "color: green"
        elif "N√≠zk√Ω" in val or "Slab√Ω" in val:
            return "color: red"
        return "color: black"

    def color_momentum(val):
        if "Pozitivn√≠" in val:
            return "background-color: #d1fae5"
        elif "Negativn√≠" in val:
            return "background-color: #fee2e2"
        return ""

    styled_df = df.copy()
    styled_df["Status"] = styled_df["Status"].apply(style_status)

    return styled_df.style.applymap(color_performance, subset=["Overperformance"])\
                          .applymap(color_momentum, subset=["Momentum"])\
                          .format(precision=1)




def calculate_match_style_score_per_match(df: pd.DataFrame) -> pd.DataFrame:
    """P≈ôid√° komplexn√≠ metriky stylu hry do ka≈æd√©ho z√°pasu."""
    df = prepare_df(df)

    # Z√°kladn√≠ slo≈æky
    df['Tempo'] = df['HS'] + df['AS'] + df['HC'] + df['AC'] + df['HF'] + df['AF']
    df['Goly'] = df['FTHG'] + df['FTAG']
    # Replace zero shots on target with a small float to avoid division by zero
    shots_on_target = (df['HST'] + df['AST']).astype(float).replace(0, 0.1)
    df['Konverze'] = (df['FTHG'] + df['FTAG']) / shots_on_target
    df['Agrese'] = df['HY'] + df['AY'] + 2 * (df['HR'] + df['AR']) + df['HF'] + df['AF']

    # Normalizace pro slo≈æky do 0‚Äì1
    for col in ['Tempo', 'Goly', 'Konverze', 'Agrese']:
        min_val = df[col].min()
        max_val = df[col].max()
        df[col + "_norm"] = (df[col] - min_val) / (max_val - min_val + 1e-5)

    # V√Ωpoƒçet fin√°ln√≠ho sk√≥re (0‚Äì100)
    df['MatchStyleScore'] = (
        0.55 * df['Tempo_norm'] +
        0.25 * df['Goly_norm'] +
        0.10 * df['Konverze_norm'] +
        0.10 * df['Agrese_norm']
    ) * 100

    return df


def calculate_gii_zscore(df: pd.DataFrame) -> pd.DataFrame:
    """
    Vrac√≠ GII index (Game Intensity Index) pro ka≈æd√Ω z√°pas
    na z√°kladƒõ MatchStyleScore.
    """
    df = calculate_match_style_score_per_match(df)

    gii_mean = df['MatchStyleScore'].mean()
    gii_std = df['MatchStyleScore'].std()

    df['GII'] = (df['MatchStyleScore'] - gii_mean) / (gii_std + 1e-5)

    return df


def calculate_gii_for_team(df: pd.DataFrame, team: str) -> float:
    """Spoƒç√≠t√° GII pro t√Ωm = pr≈Ømƒõr (st≈ôely + rohy + fauly) na z√°pas."""
    df = prepare_df(df)

    home = df[df['HomeTeam'] == team]
    away = df[df['AwayTeam'] == team]

    if home.empty and away.empty:
        return 0.0

    shots = pd.concat([home['HS'], away['AS']])
    corners = pd.concat([home['HC'], away['AC']])
    fouls = pd.concat([home['HF'], away['AF']])

    gii = (shots + corners + fouls).mean()

    return round(gii, 2)

def calculate_league_gii(df: pd.DataFrame) -> float:
    """Spoƒç√≠t√° pr≈Ømƒõrn√© GII v cel√© lize."""
    df = prepare_df(df)

    shots = df['HS'] + df['AS']
    corners = df['HC'] + df['AC']
    fouls = df['HF'] + df['AF']

    total_actions = shots + corners + fouls
    matches = len(df)

    league_gii = total_actions.sum() / matches

    return round(league_gii, 2)

def calculate_attack_volume(df: pd.DataFrame, team: str) -> float:
    """Spoƒç√≠t√° objem √∫tok≈Ø = (st≈ôely + rohy) na z√°pas."""
    df = prepare_df(df)

    home = df[df['HomeTeam'] == team]
    away = df[df['AwayTeam'] == team]

    if home.empty and away.empty:
        return 0.0

    shots = pd.concat([home['HS'], away['AS']])
    corners = pd.concat([home['HC'], away['AC']])

    volume = (shots + corners).mean()

    return round(volume, 2)

def calculate_attack_efficiency(df: pd.DataFrame, team: str) -> float:
    """Spoƒç√≠t√° efektivitu √∫tok≈Ø = st≈ôely na br√°nu / st≈ôely."""
    df = prepare_df(df)

    home = df[df['HomeTeam'] == team]
    away = df[df['AwayTeam'] == team]

    if home.empty and away.empty:
        return 0.0

    shots = pd.concat([home['HS'], away['AS']])
    shots_on_target = pd.concat([home['HST'], away['AST']])

    if shots.sum() == 0:
        return 0.0

    efficiency = shots_on_target.sum() / shots.sum()

    return round(efficiency, 2)

def calculate_full_attacking_pressure(df: pd.DataFrame, team: str) -> float:
    """Spoƒç√≠t√° kombinovan√Ω √∫toƒçn√Ω tlak: Attack Volume √ó Attack Efficiency."""
    volume = calculate_attack_volume(df, team)
    efficiency = calculate_attack_efficiency(df, team)

    attacking_pressure = volume * efficiency

    return round(attacking_pressure, 2)

def get_team_style_vs_opponent_type(df: pd.DataFrame, team: str, opponent_team: str) -> float:
    """
    Vrac√≠ pr≈Ømƒõrn√Ω MatchStyleScore (nebo GII), kdy≈æ t√Ωm hr√°l proti soupe≈ô≈Øm stejn√© kategorie jako `opponent_team`.
    """
    

    df = calculate_match_style_score_per_match(df)
    df = prepare_df(df)

    # Zjisti s√≠lu soupe≈ôe (siln√Ω, pr≈Ømƒõrn√Ω, slab√Ω)
    opponent_class = classify_team_strength(df, opponent_team)

    # Najdi v≈°echny z√°pasy dan√©ho t√Ωmu
    matches = df[(df['HomeTeam'] == team) | (df['AwayTeam'] == team)].copy()
    matches["Opponent"] = matches.apply(
        lambda row: row["AwayTeam"] if row["HomeTeam"] == team else row["HomeTeam"], axis=1
    )

    # Zjisti s√≠lu ka≈æd√©ho soupe≈ôe
    matches["OpponentClass"] = matches["Opponent"].apply(lambda opp: classify_team_strength(df, opp))

    # Filtrovat pouze z√°pasy proti stejn√© kategorii
    filtered = matches[matches["OpponentClass"] == opponent_class]

    if filtered.empty:
        print(f"[{team}] ‚ö†Ô∏è ≈Ω√°dn√© z√°pasy proti {opponent_class} t√Ωm≈Øm.")
        return None

    # V√Ωpoƒçet pr≈Ømƒõrn√©ho stylu (MatchStyleScore)
    return round(filtered["MatchStyleScore"].mean(), 1)


def get_team_average_gii(df: pd.DataFrame) -> dict:
    """
    Vrac√≠ dict: t√Ωm -> pr≈Ømƒõrn√© Z-sk√≥re GII (intenzity) na z√°kladƒõ z√°pas≈Ø.
    Pou≈æ√≠v√° p≈ôedzpracovan√Ω 'MatchStyleScore' a Z-sk√≥rovou normalizaci.
    """
    df = calculate_match_style_score_per_match(df)

    # V√Ωpoƒçet Z-sk√≥re GII z MatchStyleScore
    mean = df['MatchStyleScore'].mean()
    std = df['MatchStyleScore'].std()
    df['GII'] = (df['MatchStyleScore'] - mean) / (std + 1e-5)

    teams = pd.concat([df['HomeTeam'], df['AwayTeam']]).unique()
    gii_dict = {}

    for team in teams:
        gii_home = df[df['HomeTeam'] == team]['GII']
        gii_away = df[df['AwayTeam'] == team]['GII']
        values = pd.concat([gii_home, gii_away])
        if len(values) >= 3:  # min poƒçet z√°pas≈Ø
            gii_dict[team] = round(values.mean(), 2)
        else:
            gii_dict[team] = None  # nebo 0.0, nebo nezobrazit

    return gii_dict


def calculate_team_styles(df: pd.DataFrame) -> tuple:
    """Vrac√≠ DataFramy ofenzivn√≠ho a defenzivn√≠ho stylu t√Ωm≈Ø."""
    df = prepare_df(df)
    offensive_style = []
    defensive_style = []
    teams = pd.concat([df['HomeTeam'], df['AwayTeam']]).unique()

    for team in teams:
        home = df[df['HomeTeam'] == team]
        away = df[df['AwayTeam'] == team]
        shots = pd.concat([home['HS'], away['AS']]).mean()
        sot = pd.concat([home['HST'], away['AST']]).mean()
        corners = pd.concat([home['HC'], away['AC']]).mean()
        xg = (sot * (pd.concat([home['FTHG'], away['FTAG']]).sum() / sot)) if sot > 0 else 0
        fouls = pd.concat([home['HF'], away['AF']]).mean()

        offensive_index = shots * 0.25 + sot * 0.25 + corners * 0.2 + xg * 0.2 + fouls * 0.1
        defensive_index = (1 / (shots + 1)) * 0.3 + (1 / (sot + 1)) * 0.25 + (1 / (corners + 1)) * 0.2 + (1 / (xg + 0.1)) * 0.15 + (1 / (fouls + 1)) * 0.1

        offensive_style.append({"T√Ωm": team, "Ofenzivn√≠ styl index": round(offensive_index, 2)})
        defensive_style.append({"T√Ωm": team, "Defenzivn√≠ styl index": round(defensive_index, 2)})

    off_df = pd.DataFrame(offensive_style).sort_values("Ofenzivn√≠ styl index", ascending=False).reset_index(drop=True)
    def_df = pd.DataFrame(defensive_style).sort_values("Defenzivn√≠ styl index", ascending=False).reset_index(drop=True)

    return off_df, def_df

def intensity_score_to_emoji(score: float | None) -> str:
    """P≈ôevede sk√≥re GII na emoji.

    Funkce je odoln√° v≈Øƒçi ``None`` i neƒç√≠seln√Ωm hodnot√°m. Pokud nen√≠ k
    dispozici validn√≠ ƒç√≠seln√© sk√≥re, vrac√≠ pr√°zdn√Ω ≈ôetƒõzec nam√≠sto
    vyhazov√°n√≠ v√Ωjimky.
    """
    try:
        # ``score`` m≈Ø≈æe b√Ωt ``None`` nebo jin√Ω typ ‚Äì v takov√©m p≈ô√≠padƒõ se
        # konverze na ``float`` nezda≈ô√≠ a zachyt√≠me v√Ωjimku.
        score = float(score)
    except (TypeError, ValueError):
        return ""

    if score > 1.0:
        return "üî•"
    elif score > 0.3:
        return "‚ö°"
    elif score > -0.3:
        return "‚ûñ"
    else:
        return "‚ùÑÔ∏è"

def form_points_to_emoji(avg_points: float) -> str:
    """Vrac√≠ emoji podle pr≈Ømƒõrn√©ho poƒçtu bod≈Ø za z√°pas."""
    if avg_points > 2.5:
        return "üî•üî•üî•"
    elif avg_points > 2.0:
        return "üî•üî•"
    elif avg_points > 1.5:
        return "üî•"
    elif avg_points > 1.2:
        return "üí§"
    elif avg_points > 0.7:
        return "‚ùÑÔ∏è"
    elif avg_points > 0.5:
        return "‚ùÑÔ∏è‚ùÑÔ∏è"
    else:
        return "‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è"
    
def tempo_tag(tempo_value: float) -> str:
    """
    Vygeneruje barevn√Ω HTML badge podle hodnoty tempa.
    """
    if tempo_value >= 65:
        color = "#FF4B4B"  # ƒçerven√° ‚Äì extr√©mn√≠ tempo
        label = "üöÄ Extr√©mn√≠ tempo"
    elif tempo_value >= 50:
        color = "#FF8800"  # oran≈æov√° ‚Äì vysok√© tempo
        label = "üî• Vysok√© tempo"
    elif tempo_value >= 35:
        color = "#FACC15"  # ≈ælut√° ‚Äì vyrovnan√© tempo
        label = "‚öñÔ∏è Vyrovnan√© tempo"
    elif tempo_value >= 20:
        color = "#3B82F6"  # modr√° ‚Äì pomal√© tempo
        label = "üò¥ Pomal√© tempo"
    else:
        color = "#6B7280"  # ≈°ed√° ‚Äì tot√°ln√≠ nuda
        label = "üí§ Tot√°ln√≠ nuda"

    return f"""
    <div style='
        display: inline-block;
        background-color: {color};
        color: white;
        padding: 6px 10px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
    '>{label} ({tempo_value})</div>
    """


def expected_match_style_score(df: pd.DataFrame, home_team: str, away_team: str, elo_dict: dict) -> float:
    """Spoƒç√≠t√° oƒçek√°van√Ω styl z√°pasu (pr≈Ømƒõr temp dom√°c√≠ch a host≈Ø)."""
    home_tempo = calculate_match_tempo(df, home_team, elo_dict.get(away_team, 1500), is_home=True, elo_dict=elo_dict)
    away_tempo = calculate_match_tempo(df, away_team, elo_dict.get(home_team, 1500), is_home=False, elo_dict=elo_dict)

    home_tempo_value = home_tempo["tempo"]
    away_tempo_value = away_tempo["tempo"]


    return round((home_tempo_value  + away_tempo_value) / 2, 1)

def expected_match_tempo(
    df: pd.DataFrame,
    home_team: str,
    away_team: str,
    elo_dict: dict,
    home_exp: float,
    away_exp: float,
    xg_home: float,
    xg_away: float,
    last_n: int = 10
) -> float:
    """
    Vylep≈°en√© oƒçek√°van√© tempo z√°pasu, bere v √∫vahu i s√≠lu √∫toƒçn√Ωch f√°z√≠.
    """
    df = prepare_df(df)

    elo_away = elo_dict.get(away_team, 1500)
    elo_home = elo_dict.get(home_team, 1500)

    home_tempo_dict = calculate_match_tempo(df, home_team, opponent_elo=elo_away, is_home=True, elo_dict=elo_dict, last_n=last_n)
    away_tempo_dict = calculate_match_tempo(df, away_team, opponent_elo=elo_home, is_home=False, elo_dict=elo_dict, last_n=last_n)

    base_tempo = (home_tempo_dict["tempo"] + away_tempo_dict["tempo"]) / 2

    # G√≥lov√© ukazatele
    goal_potential = home_exp + away_exp
    xg_potential = xg_home + xg_away

    # Bonus za extr√©mn√≠ g√≥lov√Ω potenci√°l
    high_scoring_bonus = 5 if goal_potential >= 3.0 else 0

    # Kombinace slo≈æek (n√°soben√≠ pro vƒõt≈°√≠ rozptyl)
    combined_score = (
        base_tempo * 0.3 +
        goal_potential * 20 * 0.35 +
        xg_potential * 20 * 0.35 +
        high_scoring_bonus
    )

    return round(combined_score, 1)



def team_vs_similar_opponents_tempo(df: pd.DataFrame, team: str, opponent_elo: float, is_home: bool, elo_dict: dict, last_n: int = 10) -> float:
    """Spoƒç√≠t√° pr≈Ømƒõrn√© tempo t√Ωmu proti soupe≈ô≈Øm s podobn√Ωm ELO."""
    df = prepare_df(df)

    tempo_dict = calculate_match_tempo(df, team, opponent_elo=opponent_elo, is_home=is_home, elo_dict=elo_dict, last_n=last_n)

    return tempo_dict["tempo"]

def tempo_to_emoji(tempo_value: float) -> str:
    """
    Vrac√≠ emoji podle tempa z√°pasu.
    """
    if tempo_value >= 65:
        return "üöÄ Extr√©mn√≠ tempo"
    elif tempo_value >= 50:
        return "üî• Vysok√© tempo"
    elif tempo_value >= 35:
        return "‚öñÔ∏è Vyrovnan√© tempo"
    elif tempo_value >= 20:
        return "üò¥ Pomal√Ω z√°pas"
    else:
        return "üí§ Tot√°ln√≠ nuda"


def calculate_advanced_team_metrics(df: pd.DataFrame, is_home: bool = None) -> pd.DataFrame:
    if df.empty:
        return pd.DataFrame(columns=[
            "T√Ωm", "Ofenzivn√≠ efektivita", "Defenzivn√≠ efektivita", 
            "P≈ôesnost st≈ôel", "Konverzn√≠ m√≠ra"
        ]).set_index("T√Ωm")
        
    teams = pd.concat([df['HomeTeam'], df['AwayTeam']]).unique()
    records = []

    for team in teams:
        home = df[df['HomeTeam'] == team]
        away = df[df['AwayTeam'] == team]

        total_shots = pd.concat([home['HS'], away['AS']]).sum()
        shots_on_target = pd.concat([home['HST'], away['AST']]).sum()
        goals = pd.concat([home['FTHG'], away['FTAG']]).sum()
        conceded = pd.concat([home['FTAG'], away['FTHG']]).sum()

        offensive_eff = total_shots / goals if goals > 0 else 0
        defensive_eff = conceded / total_shots if total_shots > 0 else 0
        shot_accuracy = shots_on_target / total_shots if total_shots > 0 else 0
        conversion_rate = goals / total_shots if total_shots > 0 else 0

        records.append({
            "T√Ωm": team,
            "Ofenzivn√≠ efektivita": offensive_eff,
            "Defenzivn√≠ efektivita": defensive_eff,
            "P≈ôesnost st≈ôel": shot_accuracy,
            "Konverzn√≠ m√≠ra": conversion_rate,
        })

    return pd.DataFrame(records).set_index("T√Ωm")

def calculate_team_extra_stats(df: pd.DataFrame, team: str) -> dict:
    if df.empty:
        return {"ƒåist√° konta %": 0.0, "Over 2.5 %": 0.0, "BTTS %": 0.0}

    is_home = df['HomeTeam'] == team
    is_away = df['AwayTeam'] == team

    goals_conceded = df.loc[is_home, 'FTAG'].tolist() + df.loc[is_away, 'FTHG'].tolist()
    clean_sheets = sum(1 for g in goals_conceded if g == 0)
    cs_pct = 100 * clean_sheets / len(goals_conceded) if goals_conceded else 0

    over_25 = ((df['FTHG'] + df['FTAG']) > 2.5).mean() * 100
    btts = ((df['FTHG'] > 0) & (df['FTAG'] > 0)).mean() * 100

    return {
        "ƒåist√° konta %": cs_pct,
        "Over 2.5 %": over_25,
        "BTTS %": btts
    }
    
def get_team_record(df, team, side=None):
    if side == "home":
        matches = df[df["HomeTeam"] == team]
        wins = matches[matches["FTR"] == "H"]
        draws = matches[matches["FTR"] == "D"]
        losses = matches[matches["FTR"] == "A"]
        return len(wins), len(draws), len(losses)

    elif side == "away":
        matches = df[df["AwayTeam"] == team]
        wins = matches[matches["FTR"] == "A"]
        draws = matches[matches["FTR"] == "D"]
        losses = matches[matches["FTR"] == "H"]
        return len(wins), len(draws), len(losses)

    else:
        matches = df[(df["HomeTeam"] == team) | (df["AwayTeam"] == team)]

        # V√Ωhra = dom√°c√≠ v√≠tƒõzstv√≠ nebo venkovn√≠ v√≠tƒõzstv√≠
        wins = matches[((matches["HomeTeam"] == team) & (matches["FTR"] == "H")) |
                       ((matches["AwayTeam"] == team) & (matches["FTR"] == "A"))]

        draws = matches[((matches["HomeTeam"] == team) | (matches["AwayTeam"] == team)) & (matches["FTR"] == "D")]

        losses = matches[((matches["HomeTeam"] == team) & (matches["FTR"] == "A")) |
                         ((matches["AwayTeam"] == team) & (matches["FTR"] == "H"))]

        return len(wins), len(draws), len(losses)


def analyze_team_profile(
    df: pd.DataFrame,
    team: str,
    conversion_rate: float,
    defensive_efficiency: float,
    yellow_per_foul: float,
    red_per_foul: float,
    df_last_matches: pd.DataFrame = None
) -> dict:
    team_df = df[(df['HomeTeam'] == team) | (df['AwayTeam'] == team)].copy()
    if team_df.empty:
        return {
            "forma": "N/A",
            "v√Ωhern√≠ s√©rie": 0,
            "prohern√≠ s√©rie": 0,
            "bez ƒçist√©ho konta": 0,
            "siln√© str√°nky": "Nedostatek dat",
            "rizika": "Nedostatek dat",
            "styl": "N/A",
            "profilov√© hodnocen√≠": []
        }

    # Posledn√≠ch 10 z√°pas≈Ø
    if df_last_matches is None:
        df_last_matches = team_df.sort_values("Date", ascending=False).head(10)

    results = []
    clean_sheet_count = 0
    btts_count = 0
    over25_count = 0
    conceded_2plus = 0
    win_streak = 0
    lose_streak = 0
    no_cs_streak = 0

    for _, row in df_last_matches.iterrows():
        is_home = row['HomeTeam'] == team
        gf = row['FTHG'] if is_home else row['FTAG']
        ga = row['FTAG'] if is_home else row['FTHG']
        ftr = row['FTR']

        if (ftr == 'H' and is_home) or (ftr == 'A' and not is_home):
            results.append("W")
        elif ftr == 'D':
            results.append("D")
        else:
            results.append("L")

        if ga == 0:
            clean_sheet_count += 1
        else:
            no_cs_streak += 1

        if gf > 0 and ga > 0:
            btts_count += 1
        if gf + ga > 2.5:
            over25_count += 1
        if ga >= 2:
            conceded_2plus += 1

    for r in results:
        if r == "W":
            win_streak += 1
        else:
            break
    for r in results:
        if r == "L":
            lose_streak += 1
        else:
            break

    # Shrnut√≠
    strengths = []
    risks = []
    profile_tags = []

    if clean_sheet_count >= 4:
        strengths.append("ƒåast√° ƒçist√° konta")
    if win_streak >= 3:
        strengths.append("V√Ωhern√≠ s√©rie")
    if btts_count >= 7:
        strengths.append("Z√°bavn√© z√°pasy (BTTS)")
    if over25_count >= 7:
        strengths.append("ƒåast√© Over 2.5")

    if conceded_2plus >= 4:
        risks.append("ƒåasto inkasuje 2+ g√≥ly")
    if lose_streak >= 3:
        risks.append("S√©rie proher")
    if no_cs_streak >= 5:
        risks.append("Dlouho bez ƒçist√©ho konta")

    # ‚ú¥Ô∏è Roz≈°√≠≈ôen√© metriky: konverze a defenziva
    if conversion_rate > 0.15 and defensive_efficiency < 0.07:
        profile_tags.append("üí™ Dominantn√≠ t√Ωm (siln√Ω √∫tok i obrana)")
    elif conversion_rate > 0.15 and defensive_efficiency > 0.12:
        profile_tags.append("üîÅ Ofenzivn√≠ s√≠la, defenzivn√≠ slabiny")
    elif conversion_rate < 0.08 and defensive_efficiency < 0.07:
        profile_tags.append("üß§ Defenzivnƒõ pevn√Ω, ale neefektivn√≠ v √∫toku")
    elif conversion_rate < 0.08 and defensive_efficiency > 0.12:
        profile_tags.append("‚ö†Ô∏è Slab√Ω v obou smƒõrech")

    if conversion_rate > 0.15:
        profile_tags.append(f"‚öΩ Vysok√° konverzn√≠ m√≠ra ({conversion_rate * 100:.1f}%)")
    elif conversion_rate < 0.08:
        profile_tags.append(f"üö´ N√≠zk√° konverze ({conversion_rate * 100:.1f}%)")

    if defensive_efficiency > 0.12:
        profile_tags.append("‚ùó Zraniteln√° defenziva (g√≥l z ka≈æd√© 8. st≈ôely)")

    if yellow_per_foul > 0.25:
        profile_tags.append(f"üü° Fauly ƒçasto trestan√© ≈ælutou ({yellow_per_foul:.1f})")
    else:
        profile_tags.append(f"üü¢ Discipl√≠na v normƒõ ({yellow_per_foul:.1f})")

    if red_per_foul > 0.05:
        profile_tags.append(f"üî¥ Riziko ƒçerven√Ωch ({red_per_foul:.1f} na faul)")

    return {
        "forma": "".join(results[:5]),
        "v√Ωhern√≠ s√©rie": win_streak,
        "prohern√≠ s√©rie": lose_streak,
        "bez ƒçist√©ho konta": no_cs_streak,
        "siln√© str√°nky": ", ".join(strengths) if strengths else "Nen√≠ v√Ωrazn√°",
        "rizika": ", ".join(risks) if risks else "Bez z√°sadn√≠ch slabin",
        "styl": "‚ö° √ötoƒçn√Ω styl" if btts_count >= 7 and over25_count >= 7 else "üõ°Ô∏è Defenzivn√≠ t√Ωm" if clean_sheet_count >= 5 else "üîÅ Neutr√°ln√≠ profil",
        "profilov√© hodnocen√≠": profile_tags
    }


